--- net/minecraft/client/Minecraft.java
+++ net/minecraft/client/Minecraft.java
@@ -1,7 +1,8 @@
 package net.minecraft.client;
 
+import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.Queues;
 import com.google.common.collect.UnmodifiableIterator;
 import com.mojang.authlib.GameProfile;
 import com.mojang.authlib.GameProfileRepository;
 import com.mojang.authlib.minecraft.MinecraftSessionService;
@@ -13,12 +14,17 @@
 import com.mojang.blaze3d.platform.Window;
 import com.mojang.blaze3d.platform.WindowEventHandler;
 import com.mojang.blaze3d.systems.RenderSystem;
 import com.mojang.blaze3d.vertex.BufferBuilder;
 import com.mojang.blaze3d.vertex.DefaultVertexFormat;
+import com.mojang.blaze3d.vertex.PoseStack;
 import com.mojang.blaze3d.vertex.Tesselator;
 import com.mojang.datafixers.DataFixer;
+import com.mojang.datafixers.util.Function4;
+import com.mojang.serialization.DataResult;
+import com.mojang.serialization.JsonOps;
+import com.mojang.serialization.Lifecycle;
 import java.io.File;
 import java.io.IOException;
 import java.io.InputStream;
 import java.net.Proxy;
 import java.net.SocketAddress;
@@ -32,20 +38,19 @@
 import java.util.List;
 import java.util.Locale;
 import java.util.Queue;
 import java.util.UUID;
 import java.util.concurrent.CompletableFuture;
+import java.util.concurrent.ExecutionException;
 import java.util.concurrent.atomic.AtomicReference;
 import java.util.function.Function;
 import java.util.function.Supplier;
-import java.util.stream.Collectors;
 import java.util.stream.Stream;
 import javax.annotation.Nullable;
 import net.minecraft.ChatFormatting;
 import net.minecraft.CrashReport;
 import net.minecraft.CrashReportCategory;
-import net.minecraft.DefaultUncaughtExceptionHandler;
 import net.minecraft.ReportedException;
 import net.minecraft.SharedConstants;
 import net.minecraft.Util;
 import net.minecraft.client.color.block.BlockColors;
 import net.minecraft.client.color.item.ItemColors;
@@ -53,12 +58,15 @@
 import net.minecraft.client.gui.Gui;
 import net.minecraft.client.gui.chat.NarratorChatListener;
 import net.minecraft.client.gui.components.toasts.SystemToast;
 import net.minecraft.client.gui.components.toasts.ToastComponent;
 import net.minecraft.client.gui.font.FontManager;
+import net.minecraft.client.gui.screens.BackupConfirmScreen;
 import net.minecraft.client.gui.screens.ChatScreen;
+import net.minecraft.client.gui.screens.ConfirmScreen;
 import net.minecraft.client.gui.screens.ConnectScreen;
+import net.minecraft.client.gui.screens.DatapackLoadFailureScreen;
 import net.minecraft.client.gui.screens.DeathScreen;
 import net.minecraft.client.gui.screens.GenericDirtMessageScreen;
 import net.minecraft.client.gui.screens.InBedChatScreen;
 import net.minecraft.client.gui.screens.LevelLoadingScreen;
 import net.minecraft.client.gui.screens.LoadingOverlay;
@@ -72,20 +80,22 @@
 import net.minecraft.client.gui.screens.WinScreen;
 import net.minecraft.client.gui.screens.advancements.AdvancementsScreen;
 import net.minecraft.client.gui.screens.inventory.CreativeModeInventoryScreen;
 import net.minecraft.client.gui.screens.inventory.InventoryScreen;
 import net.minecraft.client.gui.screens.multiplayer.JoinMultiplayerScreen;
+import net.minecraft.client.gui.screens.worldselection.EditWorldScreen;
 import net.minecraft.client.main.GameConfig;
 import net.minecraft.client.multiplayer.ClientHandshakePacketListenerImpl;
 import net.minecraft.client.multiplayer.ClientLevel;
 import net.minecraft.client.multiplayer.ClientPacketListener;
 import net.minecraft.client.multiplayer.MultiPlayerGameMode;
 import net.minecraft.client.multiplayer.ServerData;
 import net.minecraft.client.particle.ParticleEngine;
 import net.minecraft.client.player.LocalPlayer;
 import net.minecraft.client.renderer.FogRenderer;
 import net.minecraft.client.renderer.GameRenderer;
+import net.minecraft.client.renderer.GpuWarnlistManager;
 import net.minecraft.client.renderer.ItemInHandRenderer;
 import net.minecraft.client.renderer.LevelRenderer;
 import net.minecraft.client.renderer.RenderBuffers;
 import net.minecraft.client.renderer.VirtualScreen;
 import net.minecraft.client.renderer.block.BlockModelShaper;
@@ -98,17 +108,17 @@
 import net.minecraft.client.renderer.texture.TextureAtlasSprite;
 import net.minecraft.client.renderer.texture.TextureManager;
 import net.minecraft.client.resources.ClientPackSource;
 import net.minecraft.client.resources.FoliageColorReloadListener;
 import net.minecraft.client.resources.GrassColorReloadListener;
-import net.minecraft.client.resources.LegacyResourcePackAdapter;
+import net.minecraft.client.resources.LegacyPackResourcesAdapter;
 import net.minecraft.client.resources.MobEffectTextureManager;
-import net.minecraft.client.resources.PackAdapterV4;
+import net.minecraft.client.resources.PackResourcesAdapterV4;
 import net.minecraft.client.resources.PaintingTextureManager;
+import net.minecraft.client.resources.ResourcePack;
 import net.minecraft.client.resources.SkinManager;
 import net.minecraft.client.resources.SplashManager;
-import net.minecraft.client.resources.UnopenedResourcePack;
 import net.minecraft.client.resources.language.I18n;
 import net.minecraft.client.resources.language.LanguageManager;
 import net.minecraft.client.resources.model.BakedModel;
 import net.minecraft.client.resources.model.ModelManager;
 import net.minecraft.client.searchtree.MutableSearchTree;
@@ -117,58 +127,72 @@
 import net.minecraft.client.searchtree.SearchRegistry;
 import net.minecraft.client.server.IntegratedServer;
 import net.minecraft.client.sounds.MusicManager;
 import net.minecraft.client.sounds.SoundManager;
 import net.minecraft.client.tutorial.Tutorial;
+import net.minecraft.commands.Commands;
 import net.minecraft.core.BlockPos;
 import net.minecraft.core.Direction;
+import net.minecraft.core.MappedRegistry;
 import net.minecraft.core.NonNullList;
 import net.minecraft.core.Registry;
+import net.minecraft.core.RegistryAccess;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.ListTag;
+import net.minecraft.nbt.NbtOps;
 import net.minecraft.nbt.StringTag;
 import net.minecraft.network.Connection;
 import net.minecraft.network.ConnectionProtocol;
+import net.minecraft.network.chat.CommonComponents;
 import net.minecraft.network.chat.Component;
 import net.minecraft.network.chat.KeybindComponent;
 import net.minecraft.network.chat.TextComponent;
 import net.minecraft.network.chat.TranslatableComponent;
 import net.minecraft.network.protocol.Packet;
 import net.minecraft.network.protocol.game.ServerboundPlayerActionPacket;
 import net.minecraft.network.protocol.handshake.ClientIntentionPacket;
 import net.minecraft.network.protocol.login.ServerboundHelloPacket;
+import net.minecraft.resources.RegistryReadOps;
 import net.minecraft.resources.ResourceLocation;
 import net.minecraft.server.Bootstrap;
 import net.minecraft.server.MinecraftServer;
+import net.minecraft.server.ServerResources;
 import net.minecraft.server.level.progress.ProcessorChunkProgressListener;
 import net.minecraft.server.level.progress.StoringChunkProgressListener;
-import net.minecraft.server.packs.Pack;
+import net.minecraft.server.packs.PackResources;
 import net.minecraft.server.packs.PackType;
 import net.minecraft.server.packs.metadata.pack.PackMetadataSection;
 import net.minecraft.server.packs.repository.FolderRepositorySource;
+import net.minecraft.server.packs.repository.Pack;
 import net.minecraft.server.packs.repository.PackRepository;
-import net.minecraft.server.packs.repository.UnopenedPack;
+import net.minecraft.server.packs.repository.PackSource;
+import net.minecraft.server.packs.repository.RepositorySource;
+import net.minecraft.server.packs.repository.ServerPacksSource;
 import net.minecraft.server.packs.resources.ReloadableResourceManager;
 import net.minecraft.server.packs.resources.ResourceManager;
 import net.minecraft.server.packs.resources.SimpleReloadableResourceManager;
 import net.minecraft.server.players.GameProfileCache;
+import net.minecraft.sounds.Music;
+import net.minecraft.sounds.Musics;
 import net.minecraft.tags.ItemTags;
 import net.minecraft.util.FrameTimer;
 import net.minecraft.util.Mth;
 import net.minecraft.util.Unit;
 import net.minecraft.util.datafix.DataFixers;
-import net.minecraft.util.profiling.GameProfiler;
+import net.minecraft.util.profiling.ContinuousProfiler;
+import net.minecraft.util.profiling.InactiveProfiler;
 import net.minecraft.util.profiling.ProfileResults;
 import net.minecraft.util.profiling.ProfilerFiller;
 import net.minecraft.util.profiling.ResultField;
+import net.minecraft.util.profiling.SingleTickProfiler;
 import net.minecraft.util.thread.ReentrantBlockableEventLoop;
-import net.minecraft.world.Difficulty;
 import net.minecraft.world.InteractionHand;
 import net.minecraft.world.InteractionResult;
 import net.minecraft.world.Snooper;
 import net.minecraft.world.SnooperPopulator;
 import net.minecraft.world.entity.Entity;
+import net.minecraft.world.entity.EntityType;
 import net.minecraft.world.entity.boss.enderdragon.EndCrystal;
 import net.minecraft.world.entity.decoration.ArmorStand;
 import net.minecraft.world.entity.decoration.ItemFrame;
 import net.minecraft.world.entity.decoration.LeashFenceKnotEntity;
 import net.minecraft.world.entity.decoration.Painting;
@@ -182,22 +206,25 @@
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.item.Items;
 import net.minecraft.world.item.PlayerHeadItem;
 import net.minecraft.world.item.SpawnEggItem;
 import net.minecraft.world.item.TooltipFlag;
+import net.minecraft.world.level.DataPackConfig;
+import net.minecraft.world.level.Level;
 import net.minecraft.world.level.LevelSettings;
 import net.minecraft.world.level.biome.Biome;
 import net.minecraft.world.level.block.Block;
 import net.minecraft.world.level.block.RenderShape;
 import net.minecraft.world.level.block.entity.BlockEntity;
 import net.minecraft.world.level.block.entity.SkullBlockEntity;
 import net.minecraft.world.level.block.state.BlockState;
-import net.minecraft.world.level.dimension.NetherDimension;
-import net.minecraft.world.level.dimension.end.TheEndDimension;
-import net.minecraft.world.level.storage.LevelData;
-import net.minecraft.world.level.storage.LevelStorage;
+import net.minecraft.world.level.dimension.LevelStem;
+import net.minecraft.world.level.levelgen.WorldGenSettings;
+import net.minecraft.world.level.storage.LevelResource;
 import net.minecraft.world.level.storage.LevelStorageSource;
+import net.minecraft.world.level.storage.PrimaryLevelData;
+import net.minecraft.world.level.storage.WorldData;
 import net.minecraft.world.phys.BlockHitResult;
 import net.minecraft.world.phys.EntityHitResult;
 import net.minecraft.world.phys.HitResult;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
@@ -205,10 +232,11 @@
 public class Minecraft extends ReentrantBlockableEventLoop<Runnable> implements SnooperPopulator, WindowEventHandler {
    private static Minecraft instance;
    private static final Logger LOGGER = LogManager.getLogger();
    public static final boolean ON_OSX;
    public static final ResourceLocation DEFAULT_FONT;
+   public static final ResourceLocation UNIFORM_FONT;
    public static final ResourceLocation ALT_FONT;
    private static final CompletableFuture<Unit> RESOURCE_RELOAD_INITIAL_TASK;
    private final File resourcePackDirectory;
    private final PropertyMap profileProperties;
    private final TextureManager textureManager;
@@ -240,24 +268,24 @@
    private final Proxy proxy;
    private final LevelStorageSource levelSource;
    public final FrameTimer frameTimer = new FrameTimer();
    private final boolean is64bit;
    private final boolean demo;
-   private final GameProfiler profiler = new GameProfiler(() -> {
-      return this.timer.ticks;
-   });
+   private final boolean allowsMultiplayer;
+   private final boolean allowsChat;
    private final ReloadableResourceManager resourceManager;
    private final ClientPackSource clientPackSource;
-   private final PackRepository<UnopenedResourcePack> resourcePackRepository;
+   private final PackRepository<ResourcePack> resourcePackRepository;
    private final LanguageManager languageManager;
    private final BlockColors blockColors;
    private final ItemColors itemColors;
    private final RenderTarget mainRenderTarget;
    private final SoundManager soundManager;
    private final MusicManager musicManager;
    private final FontManager fontManager;
    private final SplashManager splashManager;
+   private final GpuWarnlistManager gpuWarnlistManager;
    private final MinecraftSessionService minecraftSessionService;
    private final SkinManager skinManager;
    private final ModelManager modelManager;
    private final BlockRenderDispatcher blockRenderer;
    private final PaintingTextureManager paintingTextures;
@@ -309,53 +337,60 @@
    public boolean smartCull = true;
    private boolean windowActive;
    private final Queue<Runnable> progressTasks = Queues.newConcurrentLinkedQueue();
    @Nullable
    private CompletableFuture<Void> pendingReload;
-   private String debugPath = "root";
+   private ProfilerFiller profiler;
+   private int fpsPieRenderTicks;
+   private final ContinuousProfiler fpsPieProfiler;
+   @Nullable
+   private ProfileResults fpsPieResults;
+   private String debugPath;
 
    public Minecraft(GameConfig var1) {
       super("Client");
+      this.profiler = InactiveProfiler.INSTANCE;
+      this.fpsPieProfiler = new ContinuousProfiler(Util.timeSource, () -> {
+         return this.fpsPieRenderTicks;
+      });
+      this.debugPath = "root";
       instance = this;
       this.gameDirectory = var1.location.gameDirectory;
       File var2 = var1.location.assetDirectory;
       this.resourcePackDirectory = var1.location.resourcePackDirectory;
       this.launchedVersion = var1.game.launchVersion;
       this.versionType = var1.game.versionType;
       this.profileProperties = var1.user.profileProperties;
       this.clientPackSource = new ClientPackSource(new File(this.gameDirectory, "server-resource-packs"), var1.location.getAssetIndex());
-      this.resourcePackRepository = new PackRepository(Minecraft::createClientPackAdapter);
-      this.resourcePackRepository.addSource(this.clientPackSource);
-      this.resourcePackRepository.addSource(new FolderRepositorySource(this.resourcePackDirectory));
+      this.resourcePackRepository = new PackRepository(Minecraft::createClientPackAdapter, new RepositorySource[]{this.clientPackSource, new FolderRepositorySource(this.resourcePackDirectory, PackSource.DEFAULT)});
       this.proxy = var1.user.proxy;
       this.minecraftSessionService = (new YggdrasilAuthenticationService(this.proxy, UUID.randomUUID().toString())).createMinecraftSessionService();
       this.user = var1.user.user;
       LOGGER.info("Setting user: {}", this.user.getName());
       LOGGER.debug("(Session ID is {})", this.user.getSessionId());
       this.demo = var1.game.demo;
+      this.allowsMultiplayer = !var1.game.disableMultiplayer;
+      this.allowsChat = !var1.game.disableChat;
       this.is64bit = checkIs64Bit();
       this.singleplayerServer = null;
       String var3;
       int var4;
-      if (var1.server.hostname != null) {
+      if (this.allowsMultiplayer && var1.server.hostname != null) {
          var3 = var1.server.hostname;
          var4 = var1.server.port;
       } else {
          var3 = null;
          var4 = 0;
       }
 
-      Bootstrap.bootStrap();
-      Bootstrap.validate();
-      KeybindComponent.keyResolver = KeyMapping::createNameSupplier;
+      KeybindComponent.setKeyResolver(KeyMapping::createNameSupplier);
       this.fixerUpper = DataFixers.getDataFixer();
       this.toast = new ToastComponent(this);
       this.tutorial = new Tutorial(this);
       this.gameThread = Thread.currentThread();
       this.options = new Options(this, this.gameDirectory);
       this.hotbarManager = new HotbarManager(this.gameDirectory, this.fixerUpper);
-      this.startTimerHackThread();
       LOGGER.info("Backend library: {}", RenderSystem.getBackendDescription());
       DisplayData var5;
       if (this.options.overrideHeight > 0 && this.options.overrideWidth > 0) {
          var5 = new DisplayData(this.options.overrideWidth, this.options.overrideHeight, var1.display.fullscreenWidth, var1.display.fullscreenHeight, var1.display.isFullscreen);
       } else {
@@ -381,13 +416,13 @@
       this.keyboardHandler = new KeyboardHandler(this);
       this.keyboardHandler.setup(this.window.getWindow());
       RenderSystem.initRenderer(this.options.glDebugVerbosity, false);
       this.mainRenderTarget = new RenderTarget(this.window.getWidth(), this.window.getHeight(), true, ON_OSX);
       this.mainRenderTarget.setClearColor(0.0F, 0.0F, 0.0F, 0.0F);
-      this.resourceManager = new SimpleReloadableResourceManager(PackType.CLIENT_RESOURCES, this.gameThread);
-      this.options.loadResourcePacks(this.resourcePackRepository);
+      this.resourceManager = new SimpleReloadableResourceManager(PackType.CLIENT_RESOURCES);
       this.resourcePackRepository.reload();
+      this.options.loadSelectedResourcePacks(this.resourcePackRepository);
       this.languageManager = new LanguageManager(this.options.languageCode);
       this.resourceManager.registerReloadListener(this.languageManager);
       this.textureManager = new TextureManager(this.resourceManager);
       this.resourceManager.registerReloadListener(this.textureManager);
       this.skinManager = new SkinManager(this.textureManager, new File(var2, "skins"), this.minecraftSessionService);
@@ -395,76 +430,72 @@
       this.soundManager = new SoundManager(this.resourceManager, this.options);
       this.resourceManager.registerReloadListener(this.soundManager);
       this.splashManager = new SplashManager(this.user);
       this.resourceManager.registerReloadListener(this.splashManager);
       this.musicManager = new MusicManager(this);
-      this.fontManager = new FontManager(this.textureManager, this.isEnforceUnicode());
+      this.fontManager = new FontManager(this.textureManager);
+      this.font = this.fontManager.createFont();
       this.resourceManager.registerReloadListener(this.fontManager.getReloadListener());
-      Font var9 = this.fontManager.get(DEFAULT_FONT);
-      if (var9 == null) {
-         throw new IllegalStateException("Default font is null");
+      this.selectMainFont(this.isEnforceUnicode());
+      this.resourceManager.registerReloadListener(new GrassColorReloadListener());
+      this.resourceManager.registerReloadListener(new FoliageColorReloadListener());
+      this.window.setErrorSection("Startup");
+      RenderSystem.setupDefaultState(0, 0, this.window.getWidth(), this.window.getHeight());
+      this.window.setErrorSection("Post startup");
+      this.blockColors = BlockColors.createDefault();
+      this.itemColors = ItemColors.createDefault(this.blockColors);
+      this.modelManager = new ModelManager(this.textureManager, this.blockColors, this.options.mipmapLevels);
+      this.resourceManager.registerReloadListener(this.modelManager);
+      this.itemRenderer = new ItemRenderer(this.textureManager, this.modelManager, this.itemColors);
+      this.entityRenderDispatcher = new EntityRenderDispatcher(this.textureManager, this.itemRenderer, this.resourceManager, this.font, this.options);
+      this.itemInHandRenderer = new ItemInHandRenderer(this);
+      this.resourceManager.registerReloadListener(this.itemRenderer);
+      this.renderBuffers = new RenderBuffers();
+      this.gameRenderer = new GameRenderer(this, this.resourceManager, this.renderBuffers);
+      this.resourceManager.registerReloadListener(this.gameRenderer);
+      this.blockRenderer = new BlockRenderDispatcher(this.modelManager.getBlockModelShaper(), this.blockColors);
+      this.resourceManager.registerReloadListener(this.blockRenderer);
+      this.levelRenderer = new LevelRenderer(this, this.renderBuffers);
+      this.resourceManager.registerReloadListener(this.levelRenderer);
+      this.createSearchTrees();
+      this.resourceManager.registerReloadListener(this.searchRegistry);
+      this.particleEngine = new ParticleEngine(this.level, this.textureManager);
+      this.resourceManager.registerReloadListener(this.particleEngine);
+      this.paintingTextures = new PaintingTextureManager(this.textureManager);
+      this.resourceManager.registerReloadListener(this.paintingTextures);
+      this.mobEffectTextures = new MobEffectTextureManager(this.textureManager);
+      this.resourceManager.registerReloadListener(this.mobEffectTextures);
+      this.gpuWarnlistManager = new GpuWarnlistManager();
+      this.resourceManager.registerReloadListener(this.gpuWarnlistManager);
+      this.gui = new Gui(this);
+      this.debugRenderer = new DebugRenderer(this);
+      RenderSystem.setErrorCallback(this::onFullscreenError);
+      if (this.options.fullscreen && !this.window.isFullscreen()) {
+         this.window.toggleFullScreen();
+         this.options.fullscreen = this.window.isFullscreen();
+      }
+
+      this.window.updateVsync(this.options.enableVsync);
+      this.window.updateRawMouseInput(this.options.rawMouseInput);
+      this.window.setDefaultErrorCallback();
+      this.resizeDisplay();
+      if (var3 != null) {
+         this.setScreen(new ConnectScreen(new TitleScreen(), this, var3, var4));
       } else {
-         this.font = var9;
-         this.font.setBidirectional(this.languageManager.isBidirectional());
-         this.resourceManager.registerReloadListener(new GrassColorReloadListener());
-         this.resourceManager.registerReloadListener(new FoliageColorReloadListener());
-         this.window.setErrorSection("Startup");
-         RenderSystem.setupDefaultState(0, 0, this.window.getWidth(), this.window.getHeight());
-         this.window.setErrorSection("Post startup");
-         this.blockColors = BlockColors.createDefault();
-         this.itemColors = ItemColors.createDefault(this.blockColors);
-         this.modelManager = new ModelManager(this.textureManager, this.blockColors, this.options.mipmapLevels);
-         this.resourceManager.registerReloadListener(this.modelManager);
-         this.itemRenderer = new ItemRenderer(this.textureManager, this.modelManager, this.itemColors);
-         this.entityRenderDispatcher = new EntityRenderDispatcher(this.textureManager, this.itemRenderer, this.resourceManager, this.font, this.options);
-         this.itemInHandRenderer = new ItemInHandRenderer(this);
-         this.resourceManager.registerReloadListener(this.itemRenderer);
-         this.renderBuffers = new RenderBuffers();
-         this.gameRenderer = new GameRenderer(this, this.resourceManager, this.renderBuffers);
-         this.resourceManager.registerReloadListener(this.gameRenderer);
-         this.blockRenderer = new BlockRenderDispatcher(this.modelManager.getBlockModelShaper(), this.blockColors);
-         this.resourceManager.registerReloadListener(this.blockRenderer);
-         this.levelRenderer = new LevelRenderer(this, this.renderBuffers);
-         this.resourceManager.registerReloadListener(this.levelRenderer);
-         this.createSearchTrees();
-         this.resourceManager.registerReloadListener(this.searchRegistry);
-         this.particleEngine = new ParticleEngine(this.level, this.textureManager);
-         this.resourceManager.registerReloadListener(this.particleEngine);
-         this.paintingTextures = new PaintingTextureManager(this.textureManager);
-         this.resourceManager.registerReloadListener(this.paintingTextures);
-         this.mobEffectTextures = new MobEffectTextureManager(this.textureManager);
-         this.resourceManager.registerReloadListener(this.mobEffectTextures);
-         this.gui = new Gui(this);
-         this.debugRenderer = new DebugRenderer(this);
-         RenderSystem.setErrorCallback(this::onFullscreenError);
-         if (this.options.fullscreen && !this.window.isFullscreen()) {
-            this.window.toggleFullScreen();
-            this.options.fullscreen = this.window.isFullscreen();
-         }
+         this.setScreen(new TitleScreen(true));
+      }
 
-         this.window.updateVsync(this.options.enableVsync);
-         this.window.updateRawMouseInput(this.options.rawMouseInput);
-         this.window.setDefaultErrorCallback();
-         this.resizeDisplay();
-         if (var3 != null) {
-            this.setScreen(new ConnectScreen(new TitleScreen(), this, var3, var4));
-         } else {
-            this.setScreen(new TitleScreen(true));
-         }
+      LoadingOverlay.registerTextures(this);
+      List var9 = this.resourcePackRepository.openAllSelected();
+      this.setOverlay(new LoadingOverlay(this, this.resourceManager.createFullReload(Util.backgroundExecutor(), this, RESOURCE_RELOAD_INITIAL_TASK, var9), (var1x) -> {
+         Util.ifElse(var1x, this::rollbackResourcePacks, () -> {
+            if (SharedConstants.IS_RUNNING_IN_IDE) {
+               this.selfTest();
+            }
 
-         LoadingOverlay.registerTextures(this);
-         List var10 = (List)this.resourcePackRepository.getSelected().stream().map(UnopenedPack::open).collect(Collectors.toList());
-         this.setOverlay(new LoadingOverlay(this, this.resourceManager.createFullReload(Util.backgroundExecutor(), this, RESOURCE_RELOAD_INITIAL_TASK, var10), (var2x) -> {
-            Util.ifElse(var2x, this::rollbackResourcePacks, () -> {
-               this.languageManager.reload(var10);
-               if (SharedConstants.IS_RUNNING_IN_IDE) {
-                  this.selfTest();
-               }
-
-            });
-         }, false));
-      }
+         });
+      }, false));
    }
 
    public void updateTitle() {
       this.window.setTitle(this.createTitle());
    }
@@ -497,11 +528,11 @@
    public boolean isProbablyModded() {
       return !"vanilla".equals(ClientBrandRetriever.getClientModName()) || Minecraft.class.getSigners() == null;
    }
 
    private void rollbackResourcePacks(Throwable var1) {
-      if (this.resourcePackRepository.getSelected().size() > 1) {
+      if (this.resourcePackRepository.getSelectedIds().size() > 1) {
          TextComponent var2;
          if (var1 instanceof SimpleReloadableResourceManager.ResourcePackLoadingFailure) {
             var2 = new TextComponent(((SimpleReloadableResourceManager.ResourcePackLoadingFailure)var1).getPack().getName());
          } else {
             var2 = null;
@@ -512,11 +543,11 @@
          this.options.resourcePacks.clear();
          this.options.incompatibleResourcePacks.clear();
          this.options.save();
          this.reloadResourcePacks().thenRun(() -> {
             ToastComponent var2x = this.getToasts();
-            SystemToast.addOrUpdate(var2x, SystemToast.SystemToastIds.PACK_LOAD_FAILURE, new TranslatableComponent("resourcePack.load_fail", new Object[0]), var2);
+            SystemToast.addOrUpdate(var2x, SystemToast.SystemToastIds.PACK_LOAD_FAILURE, new TranslatableComponent("resourcePack.load_fail"), var2);
          });
       } else {
          Util.throwAsRuntime(var1);
       }
 
@@ -533,37 +564,47 @@
                crash(this.delayedCrash);
                return;
             }
 
             try {
+               SingleTickProfiler var7 = SingleTickProfiler.createTickProfiler("Renderer");
+               boolean var3 = this.shouldRenderFpsPie();
+               this.startProfilers(var3, var7);
+               this.profiler.startTick();
                this.runTick(!var1);
-            } catch (OutOfMemoryError var3) {
+               this.profiler.endTick();
+               this.finishProfilers(var3, var7);
+            } catch (OutOfMemoryError var4) {
                if (var1) {
-                  throw var3;
+                  throw var4;
                }
 
                this.emergencySave();
                this.setScreen(new OutOfMemoryScreen());
                System.gc();
-               LOGGER.fatal("Out of memory", var3);
+               LOGGER.fatal("Out of memory", var4);
                var1 = true;
             }
          }
-      } catch (ReportedException var4) {
-         this.fillReport(var4.getReport());
+      } catch (ReportedException var5) {
+         this.fillReport(var5.getReport());
          this.emergencySave();
-         LOGGER.fatal("Reported exception thrown!", var4);
-         crash(var4.getReport());
-      } catch (Throwable var5) {
-         CrashReport var2 = this.fillReport(new CrashReport("Unexpected error", var5));
-         LOGGER.fatal("Unreported exception thrown!", var5);
+         LOGGER.fatal("Reported exception thrown!", var5);
+         crash(var5.getReport());
+      } catch (Throwable var6) {
+         CrashReport var2 = this.fillReport(new CrashReport("Unexpected error", var6));
+         LOGGER.fatal("Unreported exception thrown!", var6);
          this.emergencySave();
          crash(var2);
       }
 
    }
 
+   void selectMainFont(boolean var1) {
+      this.fontManager.setRenames(var1 ? ImmutableMap.of(DEFAULT_FONT, UNIFORM_FONT) : ImmutableMap.of());
+   }
+
    private void createSearchTrees() {
       ReloadableSearchTree var1 = new ReloadableSearchTree((var0) -> {
          return var0.getTooltipLines((Player)null, TooltipFlag.Default.NORMAL).stream().map((var0x) -> {
             return ChatFormatting.stripFormatting(var0x.getString()).trim();
          }).filter((var0x) -> {
@@ -636,27 +677,10 @@
 
    public String getVersionType() {
       return this.versionType;
    }
 
-   private void startTimerHackThread() {
-      Thread var1 = new Thread("Timer hack thread") {
-         public void run() {
-            while(Minecraft.this.running) {
-               try {
-                  Thread.sleep(2147483647L);
-               } catch (InterruptedException var2) {
-               }
-            }
-
-         }
-      };
-      var1.setDaemon(true);
-      var1.setUncaughtExceptionHandler(new DefaultUncaughtExceptionHandler(LOGGER));
-      var1.start();
-   }
-
    public void delayCrash(CrashReport var1) {
       this.delayedCrash = var1;
    }
 
    public static void crash(CrashReport var0) {
@@ -688,14 +712,13 @@
          if (this.overlay instanceof LoadingOverlay) {
             this.pendingReload = var1;
             return var1;
          } else {
             this.resourcePackRepository.reload();
-            List var2 = (List)this.resourcePackRepository.getSelected().stream().map(UnopenedPack::open).collect(Collectors.toList());
-            this.setOverlay(new LoadingOverlay(this, this.resourceManager.createFullReload(Util.backgroundExecutor(), this, RESOURCE_RELOAD_INITIAL_TASK, var2), (var3) -> {
-               Util.ifElse(var3, this::rollbackResourcePacks, () -> {
-                  this.languageManager.reload(var2);
+            List var2 = this.resourcePackRepository.openAllSelected();
+            this.setOverlay(new LoadingOverlay(this, this.resourceManager.createFullReload(Util.backgroundExecutor(), this, RESOURCE_RELOAD_INITIAL_TASK, var2), (var2x) -> {
+               Util.ifElse(var2x, this::rollbackResourcePacks, () -> {
                   this.levelRenderer.allChanged();
                   var1.complete((Object)null);
                });
             }, true));
             return var1;
@@ -752,11 +775,11 @@
          Iterator var20 = var14.iterator();
 
          while(var20.hasNext()) {
             ItemStack var21 = (ItemStack)var20.next();
             String var10 = var21.getDescriptionId();
-            String var11 = (new TranslatableComponent(var10, new Object[0])).getString();
+            String var11 = (new TranslatableComponent(var10)).getString();
             if (var11.toLowerCase(Locale.ROOT).equals(var18.getDescriptionId())) {
                LOGGER.debug("Missing translation for: {} {} {}", var21, var10, var21.getItem());
             }
          }
       }
@@ -769,18 +792,29 @@
 
    public LevelStorageSource getLevelSource() {
       return this.levelSource;
    }
 
+   private void openChatScreen(String var1) {
+      if (!this.isLocalServer() && !this.allowsChat()) {
+         if (this.player != null) {
+            this.player.sendMessage((new TranslatableComponent("chat.cannotSend")).withStyle(ChatFormatting.RED), Util.NIL_UUID);
+         }
+      } else {
+         this.setScreen(new ChatScreen(var1));
+      }
+
+   }
+
    public void setScreen(@Nullable Screen var1) {
       if (this.screen != null) {
          this.screen.removed();
       }
 
       if (var1 == null && this.level == null) {
          var1 = new TitleScreen();
-      } else if (var1 == null && this.player.getHealth() <= 0.0F) {
+      } else if (var1 == null && this.player.isDeadOrDying()) {
          if (this.player.shouldShowDeathScreen()) {
             var1 = new DeathScreen((Component)null, this.level.getLevelData().isHardcore());
          } else {
             this.player.respawn();
          }
@@ -853,11 +887,12 @@
          this.resourcePackRepository.close();
          this.particleEngine.close();
          this.mobEffectTextures.close();
          this.paintingTextures.close();
          this.textureManager.close();
-         Util.shutdownBackgroundExecutor();
+         this.resourceManager.close();
+         Util.shutdownExecutors();
       } catch (Throwable var5) {
          LOGGER.error("Shutdown failure!", var5);
          throw var5;
       } finally {
          this.virtualScreen.close();
@@ -867,11 +902,10 @@
    }
 
    private void runTick(boolean var1) {
       this.window.setErrorSection("Pre render");
       long var2 = Util.getNanos();
-      this.profiler.startTick();
       if (this.window.shouldClose()) {
          this.stop();
       }
 
       if (this.pendingReload != null && !(this.overlay instanceof LoadingOverlay)) {
@@ -885,61 +919,61 @@
       Runnable var9;
       while((var9 = (Runnable)this.progressTasks.poll()) != null) {
          var9.run();
       }
 
+      int var5;
       if (var1) {
-         this.timer.advanceTime(Util.getMillis());
+         var5 = this.timer.advanceTime(Util.getMillis());
          this.profiler.push("scheduledExecutables");
          this.runAllTasks();
          this.profiler.pop();
-      }
+         this.profiler.push("tick");
 
-      this.profiler.push("tick");
-      int var5;
-      if (var1) {
-         for(var5 = 0; var5 < Math.min(10, this.timer.ticks); ++var5) {
+         for(int var6 = 0; var6 < Math.min(10, var5); ++var6) {
+            this.profiler.incrementCounter("clientTick");
             this.tick();
          }
+
+         this.profiler.pop();
       }
 
       this.mouseHandler.turnPlayer();
       this.window.setErrorSection("Render");
-      this.profiler.popPush("sound");
+      this.profiler.push("sound");
       this.soundManager.updateSource(this.gameRenderer.getMainCamera());
       this.profiler.pop();
       this.profiler.push("render");
       RenderSystem.pushMatrix();
       RenderSystem.clear(16640, ON_OSX);
       this.mainRenderTarget.bindWrite(true);
       FogRenderer.setupNoFog();
       this.profiler.push("display");
       RenderSystem.enableTexture();
+      RenderSystem.enableCull();
       this.profiler.pop();
       if (!this.noRender) {
          this.profiler.popPush("gameRenderer");
          this.gameRenderer.render(this.pause ? this.pausePartialTick : this.timer.partialTick, var2, var1);
          this.profiler.popPush("toasts");
-         this.toast.render();
+         this.toast.render(new PoseStack());
          this.profiler.pop();
       }
 
-      this.profiler.endTick();
-      if (this.options.renderDebug && this.options.renderDebugCharts && !this.options.hideGui) {
-         this.profiler.continuous().enable();
-         this.renderFpsMeter();
-      } else {
-         this.profiler.continuous().disable();
+      if (this.fpsPieResults != null) {
+         this.profiler.push("fpsPie");
+         this.renderFpsMeter(new PoseStack(), this.fpsPieResults);
+         this.profiler.pop();
       }
 
+      this.profiler.push("blit");
       this.mainRenderTarget.unbindWrite();
       RenderSystem.popMatrix();
       RenderSystem.pushMatrix();
       this.mainRenderTarget.blitToScreen(this.window.getWidth(), this.window.getHeight());
       RenderSystem.popMatrix();
-      this.profiler.startTick();
-      this.profiler.push("updateDisplay");
+      this.profiler.popPush("updateDisplay");
       this.window.updateDisplay();
       var5 = this.getFramerateLimit();
       if ((double)var5 < Option.FRAMERATE_LIMIT.getMaxValue()) {
          RenderSystem.limitDisplayFPS(var5);
       }
@@ -947,39 +981,73 @@
       this.profiler.popPush("yield");
       Thread.yield();
       this.profiler.pop();
       this.window.setErrorSection("Post render");
       ++this.frames;
-      boolean var6 = this.hasSingleplayerServer() && (this.screen != null && this.screen.isPauseScreen() || this.overlay != null && this.overlay.isPauseScreen()) && !this.singleplayerServer.isPublished();
-      if (this.pause != var6) {
+      boolean var10 = this.hasSingleplayerServer() && (this.screen != null && this.screen.isPauseScreen() || this.overlay != null && this.overlay.isPauseScreen()) && !this.singleplayerServer.isPublished();
+      if (this.pause != var10) {
          if (this.pause) {
             this.pausePartialTick = this.timer.partialTick;
          } else {
             this.timer.partialTick = this.pausePartialTick;
          }
 
-         this.pause = var6;
+         this.pause = var10;
       }
 
       long var7 = Util.getNanos();
       this.frameTimer.logFrameDuration(var7 - this.lastNanoTime);
       this.lastNanoTime = var7;
+      this.profiler.push("fpsUpdate");
 
       while(Util.getMillis() >= this.lastTime + 1000L) {
          fps = this.frames;
-         this.fpsString = String.format("%d fps T: %s%s%s%s B: %d", fps, (double)this.options.framerateLimit == Option.FRAMERATE_LIMIT.getMaxValue() ? "inf" : this.options.framerateLimit, this.options.enableVsync ? " vsync" : "", this.options.fancyGraphics ? "" : " fast", this.options.renderClouds == CloudStatus.OFF ? "" : (this.options.renderClouds == CloudStatus.FAST ? " fast-clouds" : " fancy-clouds"), this.options.biomeBlendRadius);
+         this.fpsString = String.format("%d fps T: %s%s%s%s B: %d", fps, (double)this.options.framerateLimit == Option.FRAMERATE_LIMIT.getMaxValue() ? "inf" : this.options.framerateLimit, this.options.enableVsync ? " vsync" : "", this.options.graphicsMode.toString(), this.options.renderClouds == CloudStatus.OFF ? "" : (this.options.renderClouds == CloudStatus.FAST ? " fast-clouds" : " fancy-clouds"), this.options.biomeBlendRadius);
          this.lastTime += 1000L;
          this.frames = 0;
          this.snooper.prepare();
          if (!this.snooper.isStarted()) {
             this.snooper.start();
          }
       }
 
-      this.profiler.endTick();
+      this.profiler.pop();
    }
 
+   private boolean shouldRenderFpsPie() {
+      return this.options.renderDebug && this.options.renderDebugCharts && !this.options.hideGui;
+   }
+
+   private void startProfilers(boolean var1, @Nullable SingleTickProfiler var2) {
+      if (var1) {
+         if (!this.fpsPieProfiler.isEnabled()) {
+            this.fpsPieRenderTicks = 0;
+            this.fpsPieProfiler.enable();
+         }
+
+         ++this.fpsPieRenderTicks;
+      } else {
+         this.fpsPieProfiler.disable();
+      }
+
+      this.profiler = SingleTickProfiler.decorateFiller(this.fpsPieProfiler.getFiller(), var2);
+   }
+
+   private void finishProfilers(boolean var1, @Nullable SingleTickProfiler var2) {
+      if (var2 != null) {
+         var2.endTick();
+      }
+
+      if (var1) {
+         this.fpsPieResults = this.fpsPieProfiler.getResults();
+      } else {
+         this.fpsPieResults = null;
+      }
+
+      this.profiler = this.fpsPieProfiler.getFiller();
+   }
+
    public void resizeDisplay() {
       int var1 = this.window.calculateScale(this.options.guiScale, this.isEnforceUnicode());
       this.window.setGuiScale((double)var1);
       if (this.screen != null) {
          this.screen.resize(this, this.window.getGuiScaledWidth(), this.window.getGuiScaledHeight());
@@ -989,10 +1057,14 @@
       var2.resize(this.window.getWidth(), this.window.getHeight(), ON_OSX);
       this.gameRenderer.resize(this.window.getWidth(), this.window.getHeight());
       this.mouseHandler.setIgnoreFirstMove();
    }
 
+   public void cursorEntered() {
+      this.mouseHandler.cursorEntered();
+   }
+
    private int getFramerateLimit() {
       return this.level != null || this.screen == null && this.overlay == null ? this.window.getFramerateLimit() : 60;
    }
 
    public void emergencySave() {
@@ -1006,149 +1078,147 @@
          System.gc();
          if (this.isLocalServer && this.singleplayerServer != null) {
             this.singleplayerServer.halt(true);
          }
 
-         this.clearLevel(new GenericDirtMessageScreen(new TranslatableComponent("menu.savingLevel", new Object[0])));
+         this.clearLevel(new GenericDirtMessageScreen(new TranslatableComponent("menu.savingLevel")));
       } catch (Throwable var2) {
       }
 
       System.gc();
    }
 
    void debugFpsMeterKeyPress(int var1) {
-      ProfileResults var2 = this.profiler.continuous().getResults();
-      List var3 = var2.getTimes(this.debugPath);
-      if (!var3.isEmpty()) {
-         ResultField var4 = (ResultField)var3.remove(0);
-         if (var1 == 0) {
-            if (!var4.name.isEmpty()) {
-               int var5 = this.debugPath.lastIndexOf(30);
-               if (var5 >= 0) {
-                  this.debugPath = this.debugPath.substring(0, var5);
+      if (this.fpsPieResults != null) {
+         List var2 = this.fpsPieResults.getTimes(this.debugPath);
+         if (!var2.isEmpty()) {
+            ResultField var3 = (ResultField)var2.remove(0);
+            if (var1 == 0) {
+               if (!var3.name.isEmpty()) {
+                  int var4 = this.debugPath.lastIndexOf(30);
+                  if (var4 >= 0) {
+                     this.debugPath = this.debugPath.substring(0, var4);
+                  }
                }
-            }
-         } else {
-            --var1;
-            if (var1 < var3.size() && !"unspecified".equals(((ResultField)var3.get(var1)).name)) {
-               if (!this.debugPath.isEmpty()) {
-                  this.debugPath = this.debugPath + '\u001e';
-               }
+            } else {
+               --var1;
+               if (var1 < var2.size() && !"unspecified".equals(((ResultField)var2.get(var1)).name)) {
+                  if (!this.debugPath.isEmpty()) {
+                     this.debugPath = this.debugPath + '\u001e';
+                  }
 
-               this.debugPath = this.debugPath + ((ResultField)var3.get(var1)).name;
+                  this.debugPath = this.debugPath + ((ResultField)var2.get(var1)).name;
+               }
             }
-         }
 
+         }
       }
    }
 
-   private void renderFpsMeter() {
-      if (this.profiler.continuous().isEnabled()) {
-         ProfileResults var1 = this.profiler.continuous().getResults();
-         List var2 = var1.getTimes(this.debugPath);
-         ResultField var3 = (ResultField)var2.remove(0);
-         RenderSystem.clear(256, ON_OSX);
-         RenderSystem.matrixMode(5889);
-         RenderSystem.loadIdentity();
-         RenderSystem.ortho(0.0D, (double)this.window.getWidth(), (double)this.window.getHeight(), 0.0D, 1000.0D, 3000.0D);
-         RenderSystem.matrixMode(5888);
-         RenderSystem.loadIdentity();
-         RenderSystem.translatef(0.0F, 0.0F, -2000.0F);
-         RenderSystem.lineWidth(1.0F);
-         RenderSystem.disableTexture();
-         Tesselator var4 = Tesselator.getInstance();
-         BufferBuilder var5 = var4.getBuilder();
-         boolean var6 = true;
-         int var7 = this.window.getWidth() - 160 - 10;
-         int var8 = this.window.getHeight() - 320;
-         RenderSystem.enableBlend();
-         var5.begin(7, DefaultVertexFormat.POSITION_COLOR);
-         var5.vertex((double)((float)var7 - 176.0F), (double)((float)var8 - 96.0F - 16.0F), 0.0D).color(200, 0, 0, 0).endVertex();
-         var5.vertex((double)((float)var7 - 176.0F), (double)(var8 + 320), 0.0D).color(200, 0, 0, 0).endVertex();
-         var5.vertex((double)((float)var7 + 176.0F), (double)(var8 + 320), 0.0D).color(200, 0, 0, 0).endVertex();
-         var5.vertex((double)((float)var7 + 176.0F), (double)((float)var8 - 96.0F - 16.0F), 0.0D).color(200, 0, 0, 0).endVertex();
-         var4.end();
-         RenderSystem.disableBlend();
-         double var9 = 0.0D;
+   private void renderFpsMeter(PoseStack var1, ProfileResults var2) {
+      List var3 = var2.getTimes(this.debugPath);
+      ResultField var4 = (ResultField)var3.remove(0);
+      RenderSystem.clear(256, ON_OSX);
+      RenderSystem.matrixMode(5889);
+      RenderSystem.loadIdentity();
+      RenderSystem.ortho(0.0D, (double)this.window.getWidth(), (double)this.window.getHeight(), 0.0D, 1000.0D, 3000.0D);
+      RenderSystem.matrixMode(5888);
+      RenderSystem.loadIdentity();
+      RenderSystem.translatef(0.0F, 0.0F, -2000.0F);
+      RenderSystem.lineWidth(1.0F);
+      RenderSystem.disableTexture();
+      Tesselator var5 = Tesselator.getInstance();
+      BufferBuilder var6 = var5.getBuilder();
+      boolean var7 = true;
+      int var8 = this.window.getWidth() - 160 - 10;
+      int var9 = this.window.getHeight() - 320;
+      RenderSystem.enableBlend();
+      var6.begin(7, DefaultVertexFormat.POSITION_COLOR);
+      var6.vertex((double)((float)var8 - 176.0F), (double)((float)var9 - 96.0F - 16.0F), 0.0D).color(200, 0, 0, 0).endVertex();
+      var6.vertex((double)((float)var8 - 176.0F), (double)(var9 + 320), 0.0D).color(200, 0, 0, 0).endVertex();
+      var6.vertex((double)((float)var8 + 176.0F), (double)(var9 + 320), 0.0D).color(200, 0, 0, 0).endVertex();
+      var6.vertex((double)((float)var8 + 176.0F), (double)((float)var9 - 96.0F - 16.0F), 0.0D).color(200, 0, 0, 0).endVertex();
+      var5.end();
+      RenderSystem.disableBlend();
+      double var10 = 0.0D;
 
-         ResultField var12;
-         int var14;
-         for(Iterator var11 = var2.iterator(); var11.hasNext(); var9 += var12.percentage) {
-            var12 = (ResultField)var11.next();
-            int var13 = Mth.floor(var12.percentage / 4.0D) + 1;
-            var5.begin(6, DefaultVertexFormat.POSITION_COLOR);
-            var14 = var12.getColor();
-            int var15 = var14 >> 16 & 255;
-            int var16 = var14 >> 8 & 255;
-            int var17 = var14 & 255;
-            var5.vertex((double)var7, (double)var8, 0.0D).color(var15, var16, var17, 255).endVertex();
+      ResultField var13;
+      int var15;
+      for(Iterator var12 = var3.iterator(); var12.hasNext(); var10 += var13.percentage) {
+         var13 = (ResultField)var12.next();
+         int var14 = Mth.floor(var13.percentage / 4.0D) + 1;
+         var6.begin(6, DefaultVertexFormat.POSITION_COLOR);
+         var15 = var13.getColor();
+         int var16 = var15 >> 16 & 255;
+         int var17 = var15 >> 8 & 255;
+         int var18 = var15 & 255;
+         var6.vertex((double)var8, (double)var9, 0.0D).color(var16, var17, var18, 255).endVertex();
 
-            int var18;
-            float var19;
-            float var20;
-            float var21;
-            for(var18 = var13; var18 >= 0; --var18) {
-               var19 = (float)((var9 + var12.percentage * (double)var18 / (double)var13) * 6.2831854820251465D / 100.0D);
-               var20 = Mth.sin(var19) * 160.0F;
-               var21 = Mth.cos(var19) * 160.0F * 0.5F;
-               var5.vertex((double)((float)var7 + var20), (double)((float)var8 - var21), 0.0D).color(var15, var16, var17, 255).endVertex();
-            }
+         int var19;
+         float var20;
+         float var21;
+         float var22;
+         for(var19 = var14; var19 >= 0; --var19) {
+            var20 = (float)((var10 + var13.percentage * (double)var19 / (double)var14) * 6.2831854820251465D / 100.0D);
+            var21 = Mth.sin(var20) * 160.0F;
+            var22 = Mth.cos(var20) * 160.0F * 0.5F;
+            var6.vertex((double)((float)var8 + var21), (double)((float)var9 - var22), 0.0D).color(var16, var17, var18, 255).endVertex();
+         }
 
-            var4.end();
-            var5.begin(5, DefaultVertexFormat.POSITION_COLOR);
+         var5.end();
+         var6.begin(5, DefaultVertexFormat.POSITION_COLOR);
 
-            for(var18 = var13; var18 >= 0; --var18) {
-               var19 = (float)((var9 + var12.percentage * (double)var18 / (double)var13) * 6.2831854820251465D / 100.0D);
-               var20 = Mth.sin(var19) * 160.0F;
-               var21 = Mth.cos(var19) * 160.0F * 0.5F;
-               if (var21 <= 0.0F) {
-                  var5.vertex((double)((float)var7 + var20), (double)((float)var8 - var21), 0.0D).color(var15 >> 1, var16 >> 1, var17 >> 1, 255).endVertex();
-                  var5.vertex((double)((float)var7 + var20), (double)((float)var8 - var21 + 10.0F), 0.0D).color(var15 >> 1, var16 >> 1, var17 >> 1, 255).endVertex();
-               }
+         for(var19 = var14; var19 >= 0; --var19) {
+            var20 = (float)((var10 + var13.percentage * (double)var19 / (double)var14) * 6.2831854820251465D / 100.0D);
+            var21 = Mth.sin(var20) * 160.0F;
+            var22 = Mth.cos(var20) * 160.0F * 0.5F;
+            if (var22 <= 0.0F) {
+               var6.vertex((double)((float)var8 + var21), (double)((float)var9 - var22), 0.0D).color(var16 >> 1, var17 >> 1, var18 >> 1, 255).endVertex();
+               var6.vertex((double)((float)var8 + var21), (double)((float)var9 - var22 + 10.0F), 0.0D).color(var16 >> 1, var17 >> 1, var18 >> 1, 255).endVertex();
             }
-
-            var4.end();
          }
 
-         DecimalFormat var22 = new DecimalFormat("##0.00");
-         var22.setDecimalFormatSymbols(DecimalFormatSymbols.getInstance(Locale.ROOT));
-         RenderSystem.enableTexture();
-         String var23 = ProfileResults.demanglePath(var3.name);
-         String var25 = "";
-         if (!"unspecified".equals(var23)) {
-            var25 = var25 + "[0] ";
-         }
+         var5.end();
+      }
 
-         if (var23.isEmpty()) {
-            var25 = var25 + "ROOT ";
-         } else {
-            var25 = var25 + var23 + ' ';
-         }
+      DecimalFormat var23 = new DecimalFormat("##0.00");
+      var23.setDecimalFormatSymbols(DecimalFormatSymbols.getInstance(Locale.ROOT));
+      RenderSystem.enableTexture();
+      String var24 = ProfileResults.demanglePath(var4.name);
+      String var26 = "";
+      if (!"unspecified".equals(var24)) {
+         var26 = var26 + "[0] ";
+      }
 
-         var14 = 16777215;
-         this.font.drawShadow(var25, (float)(var7 - 160), (float)(var8 - 80 - 16), 16777215);
-         var25 = var22.format(var3.globalPercentage) + "%";
-         this.font.drawShadow(var25, (float)(var7 + 160 - this.font.width(var25)), (float)(var8 - 80 - 16), 16777215);
+      if (var24.isEmpty()) {
+         var26 = var26 + "ROOT ";
+      } else {
+         var26 = var26 + var24 + ' ';
+      }
 
-         for(int var24 = 0; var24 < var2.size(); ++var24) {
-            ResultField var28 = (ResultField)var2.get(var24);
-            StringBuilder var26 = new StringBuilder();
-            if ("unspecified".equals(var28.name)) {
-               var26.append("[?] ");
-            } else {
-               var26.append("[").append(var24 + 1).append("] ");
-            }
+      var15 = 16777215;
+      this.font.drawShadow(var1, var26, (float)(var8 - 160), (float)(var9 - 80 - 16), 16777215);
+      var26 = var23.format(var4.globalPercentage) + "%";
+      this.font.drawShadow(var1, var26, (float)(var8 + 160 - this.font.width(var26)), (float)(var9 - 80 - 16), 16777215);
 
-            String var27 = var26.append(var28.name).toString();
-            this.font.drawShadow(var27, (float)(var7 - 160), (float)(var8 + 80 + var24 * 8 + 20), var28.getColor());
-            var27 = var22.format(var28.percentage) + "%";
-            this.font.drawShadow(var27, (float)(var7 + 160 - 50 - this.font.width(var27)), (float)(var8 + 80 + var24 * 8 + 20), var28.getColor());
-            var27 = var22.format(var28.globalPercentage) + "%";
-            this.font.drawShadow(var27, (float)(var7 + 160 - this.font.width(var27)), (float)(var8 + 80 + var24 * 8 + 20), var28.getColor());
+      for(int var25 = 0; var25 < var3.size(); ++var25) {
+         ResultField var29 = (ResultField)var3.get(var25);
+         StringBuilder var27 = new StringBuilder();
+         if ("unspecified".equals(var29.name)) {
+            var27.append("[?] ");
+         } else {
+            var27.append("[").append(var25 + 1).append("] ");
          }
 
+         String var28 = var27.append(var29.name).toString();
+         this.font.drawShadow(var1, var28, (float)(var8 - 160), (float)(var9 + 80 + var25 * 8 + 20), var29.getColor());
+         var28 = var23.format(var29.percentage) + "%";
+         this.font.drawShadow(var1, var28, (float)(var8 + 160 - 50 - this.font.width(var28)), (float)(var9 + 80 + var25 * 8 + 20), var29.getColor());
+         var28 = var23.format(var29.globalPercentage) + "%";
+         this.font.drawShadow(var1, var28, (float)(var8 + 160 - this.font.width(var28)), (float)(var9 + 80 + var25 * 8 + 20), var29.getColor());
       }
+
    }
 
    public void stop() {
       this.running = false;
    }
@@ -1322,11 +1392,11 @@
       if (this.level != null) {
          this.textureManager.tick();
       }
 
       if (this.screen == null && this.player != null) {
-         if (this.player.getHealth() <= 0.0F && !(this.screen instanceof DeathScreen)) {
+         if (this.player.isDeadOrDying() && !(this.screen instanceof DeathScreen)) {
             this.setScreen((Screen)null);
          } else if (this.player.isSleeping() && this.level != null) {
             this.setScreen(new InBedChatScreen());
          }
       } else if (this.screen != null && this.screen instanceof InBedChatScreen && !this.player.isSleeping()) {
@@ -1383,11 +1453,10 @@
       }
 
       this.soundManager.tick(this.pause);
       if (this.level != null) {
          if (!this.pause) {
-            this.level.setSpawnSettings(this.level.getDifficulty() != Difficulty.PEACEFUL, true);
             this.tutorial.tick();
 
             try {
                this.level.tick(() -> {
                   return true;
@@ -1467,13 +1536,13 @@
 
       while(this.options.keyAdvancements.consumeClick()) {
          this.setScreen(new AdvancementsScreen(this.player.connection.getAdvancements()));
       }
 
-      while(this.options.keySwapHands.consumeClick()) {
+      while(this.options.keySwapOffhand.consumeClick()) {
          if (!this.player.isSpectator()) {
-            this.getConnection().send((Packet)(new ServerboundPlayerActionPacket(ServerboundPlayerActionPacket.Action.SWAP_HELD_ITEMS, BlockPos.ZERO, Direction.DOWN)));
+            this.getConnection().send((Packet)(new ServerboundPlayerActionPacket(ServerboundPlayerActionPacket.Action.SWAP_ITEM_WITH_OFFHAND, BlockPos.ZERO, Direction.DOWN)));
          }
       }
 
       while(this.options.keyDrop.consumeClick()) {
          if (!this.player.isSpectator() && this.player.drop(Screen.hasControlDown())) {
@@ -1482,15 +1551,15 @@
       }
 
       boolean var4 = this.options.chatVisibility != ChatVisiblity.HIDDEN;
       if (var4) {
          while(this.options.keyChat.consumeClick()) {
-            this.setScreen(new ChatScreen(""));
+            this.openChatScreen("");
          }
 
          if (this.screen == null && this.overlay == null && this.options.keyCommand.consumeClick()) {
-            this.setScreen(new ChatScreen("/"));
+            this.openChatScreen("/");
          }
       }
 
       if (this.player.isUsingItem()) {
          if (!this.options.keyUse.isDown()) {
@@ -1530,85 +1599,238 @@
       }
 
       this.continueAttack(this.screen == null && this.options.keyAttack.isDown() && this.mouseHandler.isMouseGrabbed());
    }
 
-   public void selectLevel(String var1, String var2, @Nullable LevelSettings var3) {
-      this.clearLevel();
-      LevelStorage var4 = this.levelSource.selectLevel(var1, (MinecraftServer)null);
-      LevelData var5 = var4.prepareLevel();
-      if (var5 == null && var3 != null) {
-         var5 = new LevelData(var3, var1);
-         var4.saveLevelData(var5);
+   public static DataPackConfig loadDataPacks(LevelStorageSource.LevelStorageAccess var0) {
+      MinecraftServer.convertFromRegionFormatIfNeeded(var0);
+      DataPackConfig var1 = var0.getDataPacks();
+      if (var1 == null) {
+         throw new IllegalStateException("Failed to load data pack config");
+      } else {
+         return var1;
       }
+   }
 
-      if (var3 == null) {
-         var3 = new LevelSettings(var5);
+   public static WorldData loadWorldData(LevelStorageSource.LevelStorageAccess var0, RegistryAccess.RegistryHolder var1, ResourceManager var2, DataPackConfig var3) {
+      RegistryReadOps var4 = RegistryReadOps.create(NbtOps.INSTANCE, var2, var1);
+      WorldData var5 = var0.getDataTag(var4, var3);
+      if (var5 == null) {
+         throw new IllegalStateException("Failed to load world");
+      } else {
+         return var5;
       }
+   }
 
-      this.progressListener.set((Object)null);
+   public void loadLevel(String var1) {
+      this.doLoadLevel(var1, RegistryAccess.builtin(), Minecraft::loadDataPacks, Minecraft::loadWorldData, false, Minecraft.ExperimentalDialogType.BACKUP);
+   }
 
+   public void createLevel(String var1, LevelSettings var2, RegistryAccess.RegistryHolder var3, WorldGenSettings var4) {
+      this.doLoadLevel(var1, var3, (var1x) -> {
+         return var2.getDataPackConfig();
+      }, (var3x, var4x, var5, var6) -> {
+         RegistryReadOps var7 = RegistryReadOps.create(JsonOps.INSTANCE, var5, var3);
+         DataResult var8 = var7.decodeElements(var4.dimensions(), Registry.LEVEL_STEM_REGISTRY, LevelStem.CODEC);
+         Logger var10001 = LOGGER;
+         var10001.getClass();
+         MappedRegistry var9 = (MappedRegistry)var8.resultOrPartial(var10001::error).orElse(var4.dimensions());
+         return new PrimaryLevelData(var2, var4.withDimensions(var9), var8.lifecycle());
+      }, false, Minecraft.ExperimentalDialogType.CREATE);
+   }
+
+   private void doLoadLevel(String var1, RegistryAccess.RegistryHolder var2, Function<LevelStorageSource.LevelStorageAccess, DataPackConfig> var3, Function4<LevelStorageSource.LevelStorageAccess, RegistryAccess.RegistryHolder, ResourceManager, DataPackConfig, WorldData> var4, boolean var5, Minecraft.ExperimentalDialogType var6) {
+      LevelStorageSource.LevelStorageAccess var7;
       try {
-         YggdrasilAuthenticationService var6 = new YggdrasilAuthenticationService(this.proxy, UUID.randomUUID().toString());
-         MinecraftSessionService var13 = var6.createMinecraftSessionService();
-         GameProfileRepository var15 = var6.createProfileRepository();
-         GameProfileCache var9 = new GameProfileCache(var15, new File(this.gameDirectory, MinecraftServer.USERID_CACHE_FILE.getName()));
-         SkullBlockEntity.setProfileCache(var9);
-         SkullBlockEntity.setSessionService(var13);
-         GameProfileCache.setUsesAuthentication(false);
-         this.singleplayerServer = new IntegratedServer(this, var1, var2, var3, var6, var13, var15, var9, (var1x) -> {
-            StoringChunkProgressListener var2 = new StoringChunkProgressListener(var1x + 0);
-            var2.start();
-            this.progressListener.set(var2);
-            Queue var10003 = this.progressTasks;
-            var10003.getClass();
-            return new ProcessorChunkProgressListener(var2, var10003::add);
-         });
-         this.singleplayerServer.forkAndRun();
-         this.isLocalServer = true;
-      } catch (Throwable var11) {
-         CrashReport var7 = CrashReport.forThrowable(var11, "Starting integrated server");
-         CrashReportCategory var8 = var7.addCategory("Starting integrated server");
-         var8.setDetail("Level ID", (Object)var1);
-         var8.setDetail("Level Name", (Object)var2);
-         throw new ReportedException(var7);
+         var7 = this.levelSource.createAccess(var1);
+      } catch (IOException var21) {
+         LOGGER.warn("Failed to read level {} data", var1, var21);
+         SystemToast.onWorldAccessFailure(this, var1);
+         this.setScreen((Screen)null);
+         return;
       }
 
-      while(this.progressListener.get() == null) {
-         Thread.yield();
+      Minecraft.ServerStem var8;
+      try {
+         var8 = this.makeServerStem(var2, var3, var4, var5, var7);
+      } catch (Exception var20) {
+         LOGGER.warn("Failed to load datapacks, can't proceed with server load", var20);
+         this.setScreen(new DatapackLoadFailureScreen(() -> {
+            this.doLoadLevel(var1, var2, var3, var4, true, var6);
+         }));
+
+         try {
+            var7.close();
+         } catch (IOException var16) {
+            LOGGER.warn("Failed to unlock access to level {}", var1, var16);
+         }
+
+         return;
       }
 
-      LevelLoadingScreen var12 = new LevelLoadingScreen((StoringChunkProgressListener)this.progressListener.get());
-      this.setScreen(var12);
+      WorldData var9 = var8.worldData();
+      boolean var10 = var9.worldGenSettings().isOldCustomizedWorld();
+      boolean var11 = var9.worldGenSettingsLifecycle() != Lifecycle.stable();
+      if (var6 == Minecraft.ExperimentalDialogType.NONE || !var10 && !var11) {
+         this.clearLevel();
+         this.progressListener.set((Object)null);
 
-      while(!this.singleplayerServer.isReady()) {
-         var12.tick();
-         this.runTick(false);
+         try {
+            var7.saveDataTag(var2, var9);
+            var8.serverResources().updateGlobals();
+            YggdrasilAuthenticationService var12 = new YggdrasilAuthenticationService(this.proxy, UUID.randomUUID().toString());
+            MinecraftSessionService var23 = var12.createMinecraftSessionService();
+            GameProfileRepository var25 = var12.createProfileRepository();
+            GameProfileCache var15 = new GameProfileCache(var25, new File(this.gameDirectory, MinecraftServer.USERID_CACHE_FILE.getName()));
+            SkullBlockEntity.setProfileCache(var15);
+            SkullBlockEntity.setSessionService(var23);
+            GameProfileCache.setUsesAuthentication(false);
+            this.singleplayerServer = (IntegratedServer)MinecraftServer.spin((var8x) -> {
+               return new IntegratedServer(var8x, this, var2, var7, var8.packRepository(), var8.serverResources(), var9, var23, var25, var15, (var1) -> {
+                  StoringChunkProgressListener var2 = new StoringChunkProgressListener(var1 + 0);
+                  var2.start();
+                  this.progressListener.set(var2);
+                  Queue var10003 = this.progressTasks;
+                  var10003.getClass();
+                  return new ProcessorChunkProgressListener(var2, var10003::add);
+               });
+            });
+            this.isLocalServer = true;
+         } catch (Throwable var19) {
+            CrashReport var13 = CrashReport.forThrowable(var19, "Starting integrated server");
+            CrashReportCategory var14 = var13.addCategory("Starting integrated server");
+            var14.setDetail("Level ID", (Object)var1);
+            var14.setDetail("Level Name", (Object)var9.getLevelName());
+            throw new ReportedException(var13);
+         }
 
+         while(this.progressListener.get() == null) {
+            Thread.yield();
+         }
+
+         LevelLoadingScreen var22 = new LevelLoadingScreen((StoringChunkProgressListener)this.progressListener.get());
+         this.setScreen(var22);
+         this.profiler.push("waitForServer");
+
+         while(!this.singleplayerServer.isReady()) {
+            var22.tick();
+            this.runTick(false);
+
+            try {
+               Thread.sleep(16L);
+            } catch (InterruptedException var18) {
+            }
+
+            if (this.delayedCrash != null) {
+               crash(this.delayedCrash);
+               return;
+            }
+         }
+
+         this.profiler.pop();
+         SocketAddress var24 = this.singleplayerServer.getConnection().startMemoryChannel();
+         Connection var26 = Connection.connectToLocalServer(var24);
+         var26.setListener(new ClientHandshakePacketListenerImpl(var26, this, (Screen)null, (var0) -> {
+         }));
+         var26.send(new ClientIntentionPacket(var24.toString(), 0, ConnectionProtocol.LOGIN));
+         var26.send(new ServerboundHelloPacket(this.getUser().getGameProfile()));
+         this.pendingConnection = var26;
+      } else {
+         this.displayExperimentalConfirmationDialog(var6, var1, var10, () -> {
+            this.doLoadLevel(var1, var2, var3, var4, var5, Minecraft.ExperimentalDialogType.NONE);
+         });
+         var8.close();
+
          try {
-            Thread.sleep(16L);
-         } catch (InterruptedException var10) {
+            var7.close();
+         } catch (IOException var17) {
+            LOGGER.warn("Failed to unlock access to level {}", var1, var17);
          }
 
-         if (this.delayedCrash != null) {
-            crash(this.delayedCrash);
-            return;
+      }
+   }
+
+   private void displayExperimentalConfirmationDialog(Minecraft.ExperimentalDialogType var1, String var2, boolean var3, Runnable var4) {
+      if (var1 == Minecraft.ExperimentalDialogType.BACKUP) {
+         TranslatableComponent var5;
+         TranslatableComponent var6;
+         if (var3) {
+            var5 = new TranslatableComponent("selectWorld.backupQuestion.customized");
+            var6 = new TranslatableComponent("selectWorld.backupWarning.customized");
+         } else {
+            var5 = new TranslatableComponent("selectWorld.backupQuestion.experimental");
+            var6 = new TranslatableComponent("selectWorld.backupWarning.experimental");
          }
+
+         this.setScreen(new BackupConfirmScreen((Screen)null, (var3x, var4x) -> {
+            if (var3x) {
+               EditWorldScreen.makeBackupAndShowToast(this.levelSource, var2);
+            }
+
+            var4.run();
+         }, var5, var6, false));
+      } else {
+         this.setScreen(new ConfirmScreen((var3x) -> {
+            if (var3x) {
+               var4.run();
+            } else {
+               this.setScreen((Screen)null);
+
+               try {
+                  LevelStorageSource.LevelStorageAccess var4x = this.levelSource.createAccess(var2);
+                  Throwable var5 = null;
+
+                  try {
+                     var4x.deleteLevel();
+                  } catch (Throwable var15) {
+                     var5 = var15;
+                     throw var15;
+                  } finally {
+                     if (var4x != null) {
+                        if (var5 != null) {
+                           try {
+                              var4x.close();
+                           } catch (Throwable var14) {
+                              var5.addSuppressed(var14);
+                           }
+                        } else {
+                           var4x.close();
+                        }
+                     }
+
+                  }
+               } catch (IOException var17) {
+                  SystemToast.onWorldDeleteFailure(this, var2);
+                  LOGGER.error("Failed to delete world {}", var2, var17);
+               }
+            }
+
+         }, new TranslatableComponent("selectWorld.backupQuestion.experimental"), new TranslatableComponent("selectWorld.backupWarning.experimental"), CommonComponents.GUI_PROCEED, CommonComponents.GUI_CANCEL));
       }
 
-      SocketAddress var14 = this.singleplayerServer.getConnection().startMemoryChannel();
-      Connection var16 = Connection.connectToLocalServer(var14);
-      var16.setListener(new ClientHandshakePacketListenerImpl(var16, this, (Screen)null, (var0) -> {
-      }));
-      var16.send(new ClientIntentionPacket(var14.toString(), 0, ConnectionProtocol.LOGIN));
-      var16.send(new ServerboundHelloPacket(this.getUser().getGameProfile()));
-      this.pendingConnection = var16;
    }
 
+   public Minecraft.ServerStem makeServerStem(RegistryAccess.RegistryHolder var1, Function<LevelStorageSource.LevelStorageAccess, DataPackConfig> var2, Function4<LevelStorageSource.LevelStorageAccess, RegistryAccess.RegistryHolder, ResourceManager, DataPackConfig, WorldData> var3, boolean var4, LevelStorageSource.LevelStorageAccess var5) throws InterruptedException, ExecutionException {
+      DataPackConfig var6 = (DataPackConfig)var2.apply(var5);
+      PackRepository var7 = new PackRepository(Pack::new, new RepositorySource[]{new ServerPacksSource(), new FolderRepositorySource(var5.getLevelPath(LevelResource.DATAPACK_DIR).toFile(), PackSource.WORLD)});
+
+      try {
+         DataPackConfig var8 = MinecraftServer.configurePackRepository(var7, var6, var4);
+         CompletableFuture var9 = ServerResources.loadResources(var7.openAllSelected(), Commands.CommandSelection.INTEGRATED, 2, Util.backgroundExecutor(), this);
+         this.managedBlock(var9::isDone);
+         ServerResources var10 = (ServerResources)var9.get();
+         WorldData var11 = (WorldData)var3.apply(var5, var1, var10.getResourceManager(), var8);
+         return new Minecraft.ServerStem(var7, var10, var11);
+      } catch (ExecutionException | InterruptedException var12) {
+         var7.close();
+         throw var12;
+      }
+   }
+
    public void setLevel(ClientLevel var1) {
       ProgressScreen var2 = new ProgressScreen();
-      var2.progressStartNoAbort(new TranslatableComponent("connect.joining", new Object[0]));
+      var2.progressStartNoAbort(new TranslatableComponent("connect.joining"));
       this.updateScreenAndTick(var2);
       this.level = var1;
       this.updateLevelInEngines(var1);
       if (!this.isLocalServer) {
          YggdrasilAuthenticationService var3 = new YggdrasilAuthenticationService(this.proxy, UUID.randomUUID().toString());
@@ -1639,13 +1861,17 @@
       this.gameMode = null;
       NarratorChatListener.INSTANCE.clear();
       this.updateScreenAndTick(var1);
       if (this.level != null) {
          if (var3 != null) {
+            this.profiler.push("waitForServer");
+
             while(!var3.isShutdown()) {
                this.runTick(false);
             }
+
+            this.profiler.pop();
          }
 
          this.clientPackSource.clearServerPack();
          this.gui.onDisconnected();
          this.currentServer = null;
@@ -1657,25 +1883,49 @@
       this.updateLevelInEngines((ClientLevel)null);
       this.player = null;
    }
 
    private void updateScreenAndTick(Screen var1) {
-      this.musicManager.stopPlaying();
+      this.profiler.push("forcedTick");
       this.soundManager.stop();
       this.cameraEntity = null;
       this.pendingConnection = null;
       this.setScreen(var1);
       this.runTick(false);
+      this.profiler.pop();
    }
 
+   public void forceSetScreen(Screen var1) {
+      this.profiler.push("forcedTick");
+      this.setScreen(var1);
+      this.runTick(false);
+      this.profiler.pop();
+   }
+
    private void updateLevelInEngines(@Nullable ClientLevel var1) {
       this.levelRenderer.setLevel(var1);
       this.particleEngine.setLevel(var1);
       BlockEntityRenderDispatcher.instance.setLevel(var1);
       this.updateTitle();
    }
 
+   public boolean allowsMultiplayer() {
+      return this.allowsMultiplayer;
+   }
+
+   public boolean isBlocked(UUID var1) {
+      if (this.allowsChat()) {
+         return false;
+      } else {
+         return (this.player == null || !var1.equals(this.player.getUUID())) && !var1.equals(Util.NIL_UUID);
+      }
+   }
+
+   public boolean allowsChat() {
+      return this.allowsChat;
+   }
+
    public final boolean isDemo() {
       return this.demo;
    }
 
    @Nullable
@@ -1686,13 +1936,17 @@
    public static boolean renderNames() {
       return !instance.options.hideGui;
    }
 
    public static boolean useFancyGraphics() {
-      return instance.options.fancyGraphics;
+      return instance.options.graphicsMode.getId() >= GraphicsStatus.FANCY.getId();
    }
 
+   public static boolean useShaderTransparency() {
+      return instance.options.graphicsMode.getId() >= GraphicsStatus.FABULOUS.getId();
+   }
+
    public static boolean useAmbientOcclusion() {
       return instance.options.ambientOcclusion != AmbientOcclusionStatus.OFF;
    }
 
    private void pickBlock() {
@@ -1807,12 +2061,12 @@
    }
 
    private ItemStack addCustomNbtData(ItemStack var1, BlockEntity var2) {
       CompoundTag var3 = var2.save(new CompoundTag());
       CompoundTag var4;
-      if (var1.getItem() instanceof PlayerHeadItem && var3.contains("Owner")) {
-         var4 = var3.getCompound("Owner");
+      if (var1.getItem() instanceof PlayerHeadItem && var3.contains("SkullOwner")) {
+         var4 = var3.getCompound("SkullOwner");
          var1.getOrCreateTag().put("SkullOwner", var4);
          return var1;
       } else {
          var1.addTagElement("BlockEntityTag", var3);
          var4 = new CompoundTag();
@@ -1904,14 +2158,14 @@
       String var2 = ByteOrder.nativeOrder() == ByteOrder.LITTLE_ENDIAN ? "little" : "big";
       var1.setDynamicData("endianness", var2);
       var1.setDynamicData("subtitles", this.options.showSubtitles);
       var1.setDynamicData("touch", this.options.touchscreen ? "touch" : "mouse");
       int var3 = 0;
-      Iterator var4 = this.resourcePackRepository.getSelected().iterator();
+      Iterator var4 = this.resourcePackRepository.getSelectedPacks().iterator();
 
       while(var4.hasNext()) {
-         UnopenedResourcePack var5 = (UnopenedResourcePack)var4.next();
+         ResourcePack var5 = (ResourcePack)var4.next();
          if (!var5.isRequired() && !var5.isFixedPosition()) {
             var1.setDynamicData("resource_pack[" + var3++ + "]", var5.getId());
          }
       }
 
@@ -1981,11 +2235,11 @@
 
    public ResourceManager getResourceManager() {
       return this.resourceManager;
    }
 
-   public PackRepository<UnopenedResourcePack> getResourcePackRepository() {
+   public PackRepository<ResourcePack> getResourcePackRepository() {
       return this.resourcePackRepository;
    }
 
    public ClientPackSource getClientPackSource() {
       return this.clientPackSource;
@@ -2010,30 +2264,34 @@
 
    public boolean isPaused() {
       return this.pause;
    }
 
+   public GpuWarnlistManager getGpuWarnlistManager() {
+      return this.gpuWarnlistManager;
+   }
+
    public SoundManager getSoundManager() {
       return this.soundManager;
    }
 
-   public MusicManager.Music getSituationalMusic() {
+   public Music getSituationalMusic() {
       if (this.screen instanceof WinScreen) {
-         return MusicManager.Music.CREDITS;
-      } else if (this.player == null) {
-         return MusicManager.Music.MENU;
-      } else if (this.player.level.dimension instanceof NetherDimension) {
-         return MusicManager.Music.NETHER;
-      } else if (this.player.level.dimension instanceof TheEndDimension) {
-         return this.gui.getBossOverlay().shouldPlayMusic() ? MusicManager.Music.END_BOSS : MusicManager.Music.END;
-      } else {
-         Biome.BiomeCategory var1 = this.player.level.getBiome(new BlockPos(this.player)).getBiomeCategory();
-         if (this.musicManager.isPlayingMusic(MusicManager.Music.UNDER_WATER) || this.player.isUnderWater() && !this.musicManager.isPlayingMusic(MusicManager.Music.GAME) && (var1 == Biome.BiomeCategory.OCEAN || var1 == Biome.BiomeCategory.RIVER)) {
-            return MusicManager.Music.UNDER_WATER;
+         return Musics.CREDITS;
+      } else if (this.player != null) {
+         if (this.player.level.dimension() == Level.END) {
+            return this.gui.getBossOverlay().shouldPlayMusic() ? Musics.END_BOSS : Musics.END;
          } else {
-            return this.player.abilities.instabuild && this.player.abilities.mayfly ? MusicManager.Music.CREATIVE : MusicManager.Music.GAME;
+            Biome.BiomeCategory var1 = this.player.level.getBiome(this.player.blockPosition()).getBiomeCategory();
+            if (this.musicManager.isPlayingMusic(Musics.UNDER_WATER) || this.player.isUnderWater() && (var1 == Biome.BiomeCategory.OCEAN || var1 == Biome.BiomeCategory.RIVER)) {
+               return Musics.UNDER_WATER;
+            } else {
+               return this.player.level.dimension() != Level.NETHER && this.player.abilities.instabuild && this.player.abilities.mayfly ? Musics.CREATIVE : (Music)this.level.getBiomeManager().getNoiseBiomeAtPosition(this.player.blockPosition()).getBackgroundMusic().orElse(Musics.GAME);
+            }
          }
+      } else {
+         return Musics.MENU;
       }
    }
 
    public MinecraftSessionService getMinecraftSessionService() {
       return this.minecraftSessionService;
@@ -2051,10 +2309,14 @@
    public void setCameraEntity(Entity var1) {
       this.cameraEntity = var1;
       this.gameRenderer.checkEntityPostEffect(var1);
    }
 
+   public boolean shouldEntityAppearGlowing(Entity var1) {
+      return var1.isGlowing() || this.player != null && this.player.isSpectator() && this.options.keySpectatorOutlines.isDown() && var1.getType() == EntityType.PLAYER;
+   }
+
    protected Thread getRunningThread() {
       return this.gameThread;
    }
 
    protected Runnable wrapRunnable(Runnable var1) {
@@ -2135,14 +2397,10 @@
 
    public ModelManager getModelManager() {
       return this.modelManager;
    }
 
-   public FontManager getFontManager() {
-      return this.fontManager;
-   }
-
    public PaintingTextureManager getPaintingTextures() {
       return this.paintingTextures;
    }
 
    public MobEffectTextureManager getMobEffectTextures() {
@@ -2180,43 +2438,82 @@
 
    public RenderBuffers renderBuffers() {
       return this.renderBuffers;
    }
 
-   private static UnopenedResourcePack createClientPackAdapter(String var0, boolean var1, Supplier<Pack> var2, Pack var3, PackMetadataSection var4, UnopenedPack.Position var5) {
-      int var6 = var4.getPackFormat();
-      Supplier var7 = var2;
-      if (var6 <= 3) {
-         var7 = adaptV3(var2);
+   private static ResourcePack createClientPackAdapter(String var0, boolean var1, Supplier<PackResources> var2, PackResources var3, PackMetadataSection var4, Pack.Position var5, PackSource var6) {
+      int var7 = var4.getPackFormat();
+      Supplier var8 = var2;
+      if (var7 <= 3) {
+         var8 = adaptV3(var2);
       }
 
-      if (var6 <= 4) {
-         var7 = adaptV4(var7);
+      if (var7 <= 4) {
+         var8 = adaptV4(var8);
       }
 
-      return new UnopenedResourcePack(var0, var1, var7, var3, var4, var5);
+      return new ResourcePack(var0, var1, var8, var3, var4, var5, var6);
    }
 
-   private static Supplier<Pack> adaptV3(Supplier<Pack> var0) {
+   private static Supplier<PackResources> adaptV3(Supplier<PackResources> var0) {
       return () -> {
-         return new LegacyResourcePackAdapter((Pack)var0.get(), LegacyResourcePackAdapter.V3);
+         return new LegacyPackResourcesAdapter((PackResources)var0.get(), LegacyPackResourcesAdapter.V3);
       };
    }
 
-   private static Supplier<Pack> adaptV4(Supplier<Pack> var0) {
+   private static Supplier<PackResources> adaptV4(Supplier<PackResources> var0) {
       return () -> {
-         return new PackAdapterV4((Pack)var0.get());
+         return new PackResourcesAdapterV4((PackResources)var0.get());
       };
    }
 
    public void updateMaxMipLevel(int var1) {
       this.modelManager.updateMaxMipLevel(var1);
    }
 
    static {
       ON_OSX = Util.getPlatform() == Util.OS.OSX;
       DEFAULT_FONT = new ResourceLocation("default");
+      UNIFORM_FONT = new ResourceLocation("uniform");
       ALT_FONT = new ResourceLocation("alt");
       RESOURCE_RELOAD_INITIAL_TASK = CompletableFuture.completedFuture(Unit.INSTANCE);
       reserve = new byte[10485760];
    }
+
+   public static final class ServerStem implements AutoCloseable {
+      private final PackRepository<Pack> packRepository;
+      private final ServerResources serverResources;
+      private final WorldData worldData;
+
+      private ServerStem(PackRepository<Pack> var1, ServerResources var2, WorldData var3) {
+         this.packRepository = var1;
+         this.serverResources = var2;
+         this.worldData = var3;
+      }
+
+      public PackRepository<Pack> packRepository() {
+         return this.packRepository;
+      }
+
+      public ServerResources serverResources() {
+         return this.serverResources;
+      }
+
+      public WorldData worldData() {
+         return this.worldData;
+      }
+
+      public void close() {
+         this.packRepository.close();
+         this.serverResources.close();
+      }
+   }
+
+   static enum ExperimentalDialogType {
+      NONE,
+      CREATE,
+      BACKUP;
+
+      private ExperimentalDialogType() {
+      }
+   }
 }
